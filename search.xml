<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>sql注入</title>
      <link href="/blog/sql%E6%B3%A8%E5%85%A5/"/>
      <url>/blog/sql%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<hr><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>SQL注入是发生于应用程序与数据库层的安全漏洞。简而言之，是在输入的字符串之中注入SQL指令，在设计不良的程序当中忽略了字符检查，那么这些注入进去的恶意指令就会被数据库服务器误认为是正常的SQL指令而执行，因此遭到破坏或是入侵。</p><h1 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因"></a>产生原因</h1><p>SQL注入漏洞产生的原因是网站应用程序在编写时未对用户提交至服务器的数据进行合法性校验（类型、长度、业务参数合法性、敏感字符等），同时没有对用户输入数据进行有效地特殊字符过滤，使得用户的输入直接带入数据库进行执行，超出了SQL语句原来设计的预期结果，导致了SQL注入漏洞。</p><h1 id="注入举例"><a href="#注入举例" class="headerlink" title="注入举例"></a>注入举例</h1><p>以下代码为模拟web应用程序进行登录炒作。若登录成功返回success，失败则返回fail</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$conn</span> = <span class="title function_ invoke__">mysqli_connect</span>(<span class="variable">$servername</span>, <span class="variable">$username</span>, <span class="variable">$password</span>, <span class="variable">$dbname</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$conn</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Connection failed: &quot;</span> . <span class="title function_ invoke__">mysqli_connect_error</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$username</span> = @<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span> = @<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select * from users where username = &#x27;<span class="subst">$username</span>&#x27; and password=&#x27;<span class="subst">$password</span>&#x27;;&quot;</span>;</span><br><span class="line"><span class="variable">$rs</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$conn</span>,<span class="variable">$sql</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$rs</span>-&gt;<span class="title function_ invoke__">fetch_row</span>())&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;fail&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>用户名<mark style="background: #FFB8EBA6;">username</mark>和密码<mark style="background: #FFB8EBA6;">password</mark>均来之用户的直接传入，无任何过滤，后直接拼接到SQL语句中。<br>正常用户登录时，SQL语句如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> username<span class="operator">=</span><span class="string">&#x27;admin&#x27;</span> <span class="keyword">and</span> password<span class="operator">=</span><span class="string">&#x27;password&#x27;</span></span><br></pre></td></tr></table></figure><p>攻击者尝试登录，输入用户名<mark style="background: #FFB8EBA6;">admin’ or ‘1’&#x3D;’1</mark>,输入密码123，因为是直接拼接，所以构造出的sql语句如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> username<span class="operator">=</span><span class="string">&#x27;admin&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;1&#x27;</span><span class="operator">=</span><span class="string">&#x27;1&#x27;</span> <span class="keyword">and</span> password<span class="operator">=</span><span class="string">&#x27;123&#x27;</span></span><br></pre></td></tr></table></figure><p>此时因为sql语句中存在or ‘1’&#x3D;‘1’，所以永为真，将会查询出所有的结果，也就会登录成功返回success。(也就是万能密码)</p><h1 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h1><p><strong>SQL注入漏洞可能出现在一切数据库交互的地方，常见举例如下：</strong></p><blockquote><p>简而言之：所有和数据库交互的点均可能存在SQL注入</p></blockquote><table><thead><tr><th align="left">关键字</th><th align="left">功能</th></tr></thead><tbody><tr><td align="left">增</td><td align="left">注册新用户、创建订单、添加文章……</td></tr><tr><td align="left">删</td><td align="left">删除用户、删除订单……</td></tr><tr><td align="left">改</td><td align="left">修改订单、更新用户信息……</td></tr><tr><td align="left">查</td><td align="left">查询信息、筛选订单、搜索文章……</td></tr></tbody></table><h1 id="漏洞危害"><a href="#漏洞危害" class="headerlink" title="漏洞危害"></a>漏洞危害</h1><ol><li>获取数据库访问权限，甚至获得DBA权限，从而获取数据库中所有数据，造成信息泄露；（可获取数据）</li><li>对数据库进行增删改操作，例如删除数据库中重要数据库的表（可进行增删改操作）</li><li>通过构造特殊的数据库语句，可操作数据库进入后台或插入木马，以获取整个网站和数据库的控制权限，篡改网页，发布不良信息等。（可获取网站权限）</li><li>获取服务器最高权限，远程控制服务器，甚至导致局域网被入侵；（可获取服务器权限）</li></ol><h1 id="通用修复建议"><a href="#通用修复建议" class="headerlink" title="通用修复建议"></a>通用修复建议</h1><h2 id="代码层面"><a href="#代码层面" class="headerlink" title="代码层面"></a>代码层面</h2><h3 id="输入过滤"><a href="#输入过滤" class="headerlink" title="输入过滤"></a>输入过滤</h3><ol><li>严格控制输入数据的类型；如通过id获取用户信息时，仅允许传入的id为整行</li><li>严格控制输入数据的长度；如限制用户名长度应小于20</li><li>输入合法性判断；禁止出现一些特殊字符或关键词<ul><li>‘ , “ , \ , &lt; , &gt; , &amp; ,* , ; , # , select , from , where, sub , if , union , sleep , and , or 等</li></ul></li><li>对所有可能的输入点进行判断检查，如UA、IP、Cookie等</li></ol><h3 id="预编译SQL语句（参数化查询）"><a href="#预编译SQL语句（参数化查询）" class="headerlink" title="预编译SQL语句（参数化查询）"></a>预编译SQL语句（参数化查询）</h3><p>参数化查询是一种查询类型，其中占位符用于填充参数，参数值在执行时提供。原理是采用了预编译的方法，先将SQL语句中可被用户控制的参数集进行编译，生成对应的变量集，再使用对应的设置方法，为临时变量集里面的元素进行赋值，赋值过程中会对传入的参数进行强制类型检查和安全检查。</p><p>所有与数据库交互的业务接口均采用参数化查询，参数化的语句使用参数而不是将用户输入变量直接嵌入到SQL语句中，参数化查询是防御SQL注入的最佳方法，比如：Java中的<mark style="background: #D2B3FFA6;">PreparedStatement</mark>，PHP中的<mark style="background: #FFB8EBA6;">PDO</mark>等。</p><h2 id="数据库层面"><a href="#数据库层面" class="headerlink" title="数据库层面"></a>数据库层面</h2><h3 id="最小权限原则"><a href="#最小权限原则" class="headerlink" title="最小权限原则"></a>最小权限原则</h3><p>遵循最小化权限原则，严格限制网站用户的数据库操作权限，禁止将任何高权限账户（sa，dba，root等）用于应用程序数据库访问，从而最大限度的减少注入攻击对数据库的危害。</p><h3 id="禁用敏感函数"><a href="#禁用敏感函数" class="headerlink" title="禁用敏感函数"></a>禁用敏感函数</h3><p>防止攻击者通过SQL注入获取到除数据库外的其他更高权限，如系统权限等；<br>比如MSSQL中，拒绝用户访问敏感的系统存储过程，如xp_dirtree、xp_xmdshell等。</p><h3 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a>权限控制</h3><p>限制用户仅能够访问必须使用的数据库表。</p><h3 id="统一编码"><a href="#统一编码" class="headerlink" title="统一编码"></a>统一编码</h3><p>网站与数据层的编码统一，建议全部使用UTF-8编码，避免上下层编码不一致导致一些过滤模型被绕过，比如宽字节注入等。</p><h2 id="其他层面"><a href="#其他层面" class="headerlink" title="其他层面"></a>其他层面</h2><ol><li>网站应避免抛出SQL语句执行过程中的错误信息，如类型错误、字段不匹配等，防止攻击者利用这些错误信息进行一些判断；</li><li>使用通用防注入系统，或部署WAF等。</li></ol><h1 id="TIPS"><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h1><ol><li>在测试SQL注入的时候，一定要思考后端的SQL语句是如何构造的，只有判断除后端SQL语句的大致构造情况，才能知道我们可控注入点的位置，可能是<mark style="background: #FFB8EBA6;">select sqli</mark>、<mark style="background: #D2B3FFA6;">where id</mark>&#x3D; 、<mark style="background: #ADCCFFA6;">order by sqli</mark>，这样才好对症下药。</li></ol><hr>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
